---
title: "Census Data"
description: |
  A short description of the post.
author:
  - name: Bryan Blanc
    url: https://github.com/bpb824
date: 01-14-2021
output:
  distill::distill_article:
    self_contained: false
---

*This content was presented to Nelson\\Nygaard Staff at a Lunch and Learn webinar on Friday, September 17th, 2020, and is [available as a recording here](https://web.microsoftstream.com/video/5b33f7da-577d-4788-b5b4-0340340c41f4) and embedded below.*

<p align="center"><iframe width="640" height="360" src="https://web.microsoftstream.com/embed/video/5b33f7da-577d-4788-b5b4-0340340c41f4?autoplay=false&amp;showinfo=true" allowfullscreen style="border:none;"></iframe></p>

# Introduction

Today we are going to be covering several data products provided by the U.S. Census Bureau that often in form all types of work we do at Nelson\\Nygaard, and how R packages can be used to make querying, downloading, and aggregating that data easier. We will start by discussing census geographies themselves, which can be downloaded quickly with the `tigris` package. We will then make some queries of Census demographic data using the `tidycensus` package. We will end using the `lehdr` package to understand home-work flows. These are great tools for many different types of projects across the United States. 

# Census Geographies with `tigris`

*__Acknowledgment:__ This portion of this module heavily draws upon, including direct copy-paste of markdown content, the vignettes developed for the `tigris` package, available on the package [documentation website](https://github.com/walkerke/tigris). *

Census data is provided to the public in several data products, but across all of them survey data is aggregated to both time (a paritcular year or a set of years) and place (a particular geographic area). You are likely already familiar with some census geographies. The basic breakdown of census geographies in the United States is as follows, by level of hierarchy:
1. Nation
2. State
3. County
4. Tract
5. Block group 
6. Block

There are other aggregations of those units, such as divisions and regions, as well as geographies that are important but do not neccesarily align with county/tract boundaries, such as Census Designated Places (i.e. cities, towns, other types of municipalities, and unincorporated but 'designated' places). `tigris` helps you to download all of these geographies quickly into R as `sf` objects. `tigris` is called that because all census geographies comprise the [TIGER data set](https://www.census.gov/programs-surveys/geography/technical-documentation/complete-technical-documentation/tiger-geodatabase-file.html), which stands for Topologically Integrated Geographic Encoding and Referencing. There are also linear geographies as well, such as roads, waterways, and rail lines. Typically it is preferred to use your respective city or MPO's road network, because it will be better maintained for local characteristics, but sometimes TIGER is the only option! TIGER files are given a major update every ten years coinciding with the decennial census (the 2020 census is wrapping up soon). Below, the datasets available in TIGER (and likewise, `tigris`) are enumerated with their function name. 

__Available datasets:__

Please note: cartographic boundary files in __tigris__ are not available for 2011 and 2012.  

| Function | Datasets available | Years available |
|------------------------------------------|------------------------------------------------|------------------------------|
| `nation()` | cartographic (1:5m; 1:20m) | 2013-2019 |
| `divisions()` | cartographic (1:500k; 1:5m; 1:20m) | 2013-2019 |
| `regions()` | cartographic (1:500k; 1:5m; 1:20m) | 2013-2019 |
| `states()` | TIGER/Line; cartographic (1:500k; 1:5m; 1:20m) | 1990, 2000, 2010-2019 |
| `counties()` | TIGER/Line; cartographic (1:500k; 1:5m; 1:20m) | 1990, 2000, 2010-2019 |
| `tracts()` | TIGER/Line; cartographic (1:500k) | 1990, 2000, 2010-2019 |
| `block_groups()` | TIGER/Line; cartographic (1:500k) | 1990, 2000, 2010-2019 |
| `blocks()` | TIGER/Line | 2000, 2010-2019 |
| `places()` | TIGER/Line; cartographic (1:500k) | 2011-2019 |
| `pumas()` | TIGER/Line; cartographic (1:500k) | 2012-2019 |
| `school_districts()` | TIGER/Line; cartographic | 2011-2019 |
| `zctas()` | TIGER/Line; cartographic (1:500k) | 2000, 2010, 2012-2019 |
| `congressional_districts()` | TIGER/Line; cartographic (1:500k; 1:5m; 1:20m) | 2011-2019 |
| `state_legislative_districts()` | TIGER/Line; cartographic (1:500k) | 2011-2019 |
| `voting_districts()` | TIGER/Line | 2012 |
| `area_water()` | TIGER/Line | 2011-2019 |
| `linear_water()` | TIGER/Line | 2011-2019 |
| `coastline` | TIGER/Line() | 2013-2019 |
| `core_based_statistical_areas()` | TIGER/Line; cartographic (1:500k; 1:5m; 1:20m) | 2011-2019 |
| `combined_statistical_areas()` | TIGER/Line; cartographic (1:500k; 1:5m; 1:20m) | 2011-2019 |
| `metro_divisions()` | TIGER/Line | 2011-2019 |
| `new_england()` | TIGER/Line; cartographic (1:500k) | 2011-2019 |
| `county_subdivisions()` | TIGER/Line; cartographic (1:500k) | 2010-2019 |
| `urban_areas()` | TIGER/Line; cartographic (1:500k) | 2012-2019 |
| `primary_roads()` | TIGER/Line | 2011-2019 |
| `primary_secondary_roads()` | TIGER/Line | 2011-2019 |
| `roads()` | TIGER/Line | 2011-2019 |
| `rails()` | TIGER/Line | 2011-2019 |
| `native_areas()` | TIGER/Line; cartographic (1:500k) | 2011-2019 |
| `alaska_native_regional_corporations()` | TIGER/Line; cartographic (1:500k) | 2011-2019 |
| `tribal_block_groups()` | TIGER/Line | 2011-2019 |
| `tribal_census_tracts()` | TIGER/Line | 2011-2019 |
| `tribal_subdivisions_national()` | TIGER/Line | 2011-2019 |
| `landmarks()` | TIGER/Line | 2011-2019 |
| `military()` | TIGER/Line | 2011-2019 |

As of version 1.0 (released in July 2020), tigris functions return simple features objects with a default year of 2019. To get started, choose a function from the table above and use it with a state and/or county if required (this will result in a quicker download of a smaller file). You'll get back an sf object for use in your mapping and spatial analysis projects.

Here are some examples with some Portland metro area data - we are going to try to create a leaflet map with `roads()` and `places()` within the Portland metro area. We will define the Portland metro area based on the `urban_areas()` - for more on the Census's definitions of urbanized and statistical areas, refer to [this page](https://www.census.gov/programs-surveys/geography/guidance/geo-areas.html). 

## Example - Part 1


```r
library(tigris)
library(tidyverse)
library(sf)
library(leaflet)
library(stringr)

urb_areas = urban_areas()
```

```
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   1%  |                                                                                                                                |==                                                                                                                      |   2%  |                                                                                                                                |===                                                                                                                     |   2%  |                                                                                                                                |===                                                                                                                     |   3%  |                                                                                                                                |====                                                                                                                    |   3%  |                                                                                                                                |====                                                                                                                    |   4%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |=====                                                                                                                   |   5%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |========                                                                                                                |   6%  |                                                                                                                                |========                                                                                                                |   7%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |=========                                                                                                               |   8%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |==========                                                                                                              |   9%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |===========                                                                                                             |  10%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |==============                                                                                                          |  11%  |                                                                                                                                |==============                                                                                                          |  12%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |===============                                                                                                         |  13%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |================                                                                                                        |  14%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |=================                                                                                                       |  15%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |====================                                                                                                    |  16%  |                                                                                                                                |====================                                                                                                    |  17%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |=====================                                                                                                   |  18%  |                                                                                                                                |======================                                                                                                  |  18%  |                                                                                                                                |======================                                                                                                  |  19%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |=======================                                                                                                 |  20%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |==========================                                                                                              |  21%  |                                                                                                                                |==========================                                                                                              |  22%  |                                                                                                                                |===========================                                                                                             |  22%  |                                                                                                                                |===========================                                                                                             |  23%  |                                                                                                                                |============================                                                                                            |  23%  |                                                                                                                                |============================                                                                                            |  24%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |=============================                                                                                           |  25%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |================================                                                                                        |  26%  |                                                                                                                                |================================                                                                                        |  27%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |=================================                                                                                       |  28%  |                                                                                                                                |==================================                                                                                      |  28%  |                                                                                                                                |==================================                                                                                      |  29%  |                                                                                                                                |===================================                                                                                     |  29%  |                                                                                                                                |===================================                                                                                     |  30%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  30%  |                                                                                                                                |=====================================                                                                                   |  31%  |                                                                                                                                |======================================                                                                                  |  31%  |                                                                                                                                |======================================                                                                                  |  32%  |                                                                                                                                |=======================================                                                                                 |  32%  |                                                                                                                                |=======================================                                                                                 |  33%  |                                                                                                                                |========================================                                                                                |  33%  |                                                                                                                                |========================================                                                                                |  34%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |=========================================                                                                               |  35%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  37%  |                                                                                                                                |=============================================                                                                           |  38%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |==============================================                                                                          |  39%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |===============================================                                                                         |  40%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |=================================================                                                                       |  40%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |==================================================                                                                      |  41%  |                                                                                                                                |==================================================                                                                      |  42%  |                                                                                                                                |===================================================                                                                     |  42%  |                                                                                                                                |===================================================                                                                     |  43%  |                                                                                                                                |====================================================                                                                    |  43%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |=====================================================                                                                   |  44%  |                                                                                                                                |=====================================================                                                                   |  45%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |========================================================                                                                |  46%  |                                                                                                                                |========================================================                                                                |  47%  |                                                                                                                                |=========================================================                                                               |  47%  |                                                                                                                                |=========================================================                                                               |  48%  |                                                                                                                                |==========================================================                                                              |  48%  |                                                                                                                                |==========================================================                                                              |  49%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |===========================================================                                                             |  50%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |===============================================================                                                         |  52%  |                                                                                                                                |===============================================================                                                         |  53%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |================================================================                                                        |  54%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |=================================================================                                                       |  55%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |===================================================================                                                     |  55%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |====================================================================                                                    |  56%  |                                                                                                                                |====================================================================                                                    |  57%  |                                                                                                                                |=====================================================================                                                   |  57%  |                                                                                                                                |=====================================================================                                                   |  58%  |                                                                                                                                |======================================================================                                                  |  58%  |                                                                                                                                |======================================================================                                                  |  59%  |                                                                                                                                |=======================================================================                                                 |  59%  |                                                                                                                                |=======================================================================                                                 |  60%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |==========================================================================                                              |  61%  |                                                                                                                                |==========================================================================                                              |  62%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |===========================================================================                                             |  63%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |============================================================================                                            |  64%  |                                                                                                                                |=============================================================================                                           |  64%  |                                                                                                                                |=============================================================================                                           |  65%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |=================================================================================                                       |  67%  |                                                                                                                                |=================================================================================                                       |  68%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |==================================================================================                                      |  69%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |===================================================================================                                     |  70%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |=====================================================================================                                   |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  71%  |                                                                                                                                |======================================================================================                                  |  72%  |                                                                                                                                |=======================================================================================                                 |  72%  |                                                                                                                                |=======================================================================================                                 |  73%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |========================================================================================                                |  74%  |                                                                                                                                |=========================================================================================                               |  74%  |                                                                                                                                |=========================================================================================                               |  75%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |=============================================================================================                           |  77%  |                                                                                                                                |=============================================================================================                           |  78%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |==============================================================================================                          |  79%  |                                                                                                                                |===============================================================================================                         |  79%  |                                                                                                                                |===============================================================================================                         |  80%  |                                                                                                                                |================================================================================================                        |  80%  |                                                                                                                                |=================================================================================================                       |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |===================================================================================================                     |  82%  |                                                                                                                                |===================================================================================================                     |  83%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |====================================================================================================                    |  84%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |=====================================================================================================                   |  85%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  85%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |========================================================================================================                |  86%  |                                                                                                                                |========================================================================================================                |  87%  |                                                                                                                                |=========================================================================================================               |  87%  |                                                                                                                                |=========================================================================================================               |  88%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |==========================================================================================================              |  89%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |===========================================================================================================             |  90%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |==============================================================================================================          |  91%  |                                                                                                                                |==============================================================================================================          |  92%  |                                                                                                                                |===============================================================================================================         |  92%  |                                                                                                                                |===============================================================================================================         |  93%  |                                                                                                                                |================================================================================================================        |  93%  |                                                                                                                                |================================================================================================================        |  94%  |                                                                                                                                |=================================================================================================================       |  94%  |                                                                                                                                |=================================================================================================================       |  95%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |===================================================================================================================     |  95%  |                                                                                                                                |===================================================================================================================     |  96%  |                                                                                                                                |====================================================================================================================    |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |=====================================================================================================================   |  97%  |                                                                                                                                |=====================================================================================================================   |  98%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================  |  99%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |======================================================================================================================= | 100%  |                                                                                                                                |========================================================================================================================| 100%
```

```r
head(urb_areas)
```

```
## Simple feature collection with 6 features and 12 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -119.8782 ymin: 36.15075 xmax: -86.45955 ymax: 45.87447
## geographic CRS: NAD83
##   UACE10 GEOID10           NAME10                     NAMELSAD10 LSAD10 MTFCC10 UATYP10 FUNCSTAT10   ALAND10 AWATER10  INTPTLAT10
## 1  24310   24310        Dixon, IL        Dixon, IL Urban Cluster     76   G3500       C          S  25554126   938057 +41.8529507
## 2  27847   27847     Escanaba, MI     Escanaba, MI Urban Cluster     76   G3500       C          S  46643395   283456 +45.7959215
## 3  18100   18100 Clintonville, WI Clintonville, WI Urban Cluster     76   G3500       C          S   5854687   502563 +44.6232203
## 4  06166   06166      Bedford, IN      Bedford, IN Urban Cluster     76   G3500       C          S  30413948     2314 +38.8566530
## 5  75270   75270    Riverdale, CA    Riverdale, CA Urban Cluster     76   G3500       C          S   2306821        0 +36.4310710
## 6  90946   90946      Visalia, CA     Visalia, CA Urbanized Area     75   G3500       U          S 164315581    39512 +36.2934877
##     INTPTLON10                       geometry
## 1 -089.4817439 MULTIPOLYGON (((-89.49859 4...
## 2 -087.0945936 MULTIPOLYGON (((-87.09519 4...
## 3 -088.7611283 MULTIPOLYGON (((-88.7865 44...
## 4 -086.5012383 MULTIPOLYGON (((-86.5202 38...
## 5 -119.8620544 MULTIPOLYGON (((-119.8691 3...
## 6 -119.3006857 MULTIPOLYGON (((-119.1445 3...
```

```r
portland_urban_area = urb_areas %>%
  filter(str_detect(NAME10,'Portland, OR')) %>%
  st_transform(4326)

#Union, buffer, cast, and simlify all done here to try to remove vertices from boundary, making subsetting faster (but not as precise)
simp_pdx_ua = portland_urban_area %>%
  st_transform(2269) %>%
  st_union() %>%
  st_buffer(1) %>%
  st_cast('POLYGON') %>%
  st_simplify()

#Have to query these objects by state and county separately
or_roads = roads(state='OR',county = c('Multnomah','Washington','Clackamas')) %>%
  st_transform(4326)
```

```
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |===                                                                                                                     |   2%  |                                                                                                                                |====                                                                                                                    |   3%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |========                                                                                                                |   7%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |===========                                                                                                             |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |==============                                                                                                          |  11%  |                                                                                                                                |==============                                                                                                          |  12%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |======================                                                                                                  |  18%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |==========================                                                                                              |  21%  |                                                                                                                                |==========================                                                                                              |  22%  |                                                                                                                                |============================                                                                                            |  23%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |================================                                                                                        |  26%  |                                                                                                                                |=================================                                                                                       |  28%  |                                                                                                                                |==================================                                                                                      |  29%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  31%  |                                                                                                                                |=======================================                                                                                 |  32%  |                                                                                                                                |========================================                                                                                |  33%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  38%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |==================================================                                                                      |  41%  |                                                                                                                                |===================================================                                                                     |  43%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |=========================================================                                                               |  47%  |                                                                                                                                |==========================================================                                                              |  48%  |                                                                                                                                |===========================================================                                                             |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |====================================================================                                                    |  56%  |                                                                                                                                |=====================================================================                                                   |  57%  |                                                                                                                                |=====================================================================                                                   |  58%  |                                                                                                                                |======================================================================                                                  |  59%  |                                                                                                                                |=======================================================================                                                 |  60%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |=============================================================================                                           |  65%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |=================================================================================                                       |  68%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |======================================================================================                                  |  71%  |                                                                                                                                |=======================================================================================                                 |  73%  |                                                                                                                                |========================================================================================                                |  74%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |=============================================================================================                           |  77%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |===============================================================================================                         |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |========================================================================================================                |  86%  |                                                                                                                                |=========================================================================================================               |  88%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |===============================================================================================================         |  92%  |                                                                                                                                |================================================================================================================        |  93%  |                                                                                                                                |=================================================================================================================       |  95%  |                                                                                                                                |===================================================================================================================     |  96%  |                                                                                                                                |====================================================================================================================    |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |========================================================================================================================| 100%
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   1%  |                                                                                                                                |==                                                                                                                      |   2%  |                                                                                                                                |===                                                                                                                     |   2%  |                                                                                                                                |===                                                                                                                     |   3%  |                                                                                                                                |====                                                                                                                    |   3%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |========                                                                                                                |   7%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |================                                                                                                        |  14%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |====================                                                                                                    |  17%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |======================                                                                                                  |  19%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |==========================                                                                                              |  22%  |                                                                                                                                |============================                                                                                            |  23%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |================================                                                                                        |  27%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |==================================                                                                                      |  28%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  30%  |                                                                                                                                |======================================                                                                                  |  32%  |                                                                                                                                |=======================================                                                                                 |  33%  |                                                                                                                                |========================================                                                                                |  33%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  38%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |==================================================                                                                      |  41%  |                                                                                                                                |==================================================                                                                      |  42%  |                                                                                                                                |===================================================                                                                     |  43%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |========================================================                                                                |  47%  |                                                                                                                                |=========================================================                                                               |  47%  |                                                                                                                                |==========================================================                                                              |  48%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |===============================================================                                                         |  52%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |================================================================                                                        |  54%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |====================================================================                                                    |  57%  |                                                                                                                                |======================================================================                                                  |  58%  |                                                                                                                                |=======================================================================                                                 |  59%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |============================================================================                                            |  64%  |                                                                                                                                |=============================================================================                                           |  65%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |=================================================================================                                       |  67%  |                                                                                                                                |=================================================================================                                       |  68%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  72%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |=========================================================================================                               |  74%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |=============================================================================================                           |  77%  |                                                                                                                                |=============================================================================================                           |  78%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |================================================================================================                        |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |===================================================================================================                     |  83%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |========================================================================================================                |  86%  |                                                                                                                                |========================================================================================================                |  87%  |                                                                                                                                |=========================================================================================================               |  87%  |                                                                                                                                |=========================================================================================================               |  88%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |==========================================================================================================              |  89%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |==============================================================================================================          |  91%  |                                                                                                                                |===============================================================================================================         |  92%  |                                                                                                                                |================================================================================================================        |  93%  |                                                                                                                                |=================================================================================================================       |  94%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |===================================================================================================================     |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |=====================================================================================================================   |  98%  |                                                                                                                                |======================================================================================================================  |  99%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |======================================================================================================================= | 100%  |                                                                                                                                |========================================================================================================================| 100%
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   1%  |                                                                                                                                |==                                                                                                                      |   2%  |                                                                                                                                |===                                                                                                                     |   2%  |                                                                                                                                |===                                                                                                                     |   3%  |                                                                                                                                |====                                                                                                                    |   3%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |========                                                                                                                |   7%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |==============                                                                                                          |  11%  |                                                                                                                                |==============                                                                                                          |  12%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |====================                                                                                                    |  16%  |                                                                                                                                |====================                                                                                                    |  17%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |======================                                                                                                  |  18%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |==========================                                                                                              |  21%  |                                                                                                                                |===========================                                                                                             |  22%  |                                                                                                                                |============================                                                                                            |  23%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |================================                                                                                        |  26%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |=================================                                                                                       |  28%  |                                                                                                                                |===================================                                                                                     |  29%  |                                                                                                                                |===================================                                                                                     |  30%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  31%  |                                                                                                                                |=======================================                                                                                 |  32%  |                                                                                                                                |=======================================                                                                                 |  33%  |                                                                                                                                |========================================                                                                                |  33%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  37%  |                                                                                                                                |=============================================                                                                           |  38%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |=================================================                                                                       |  40%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |===================================================                                                                     |  42%  |                                                                                                                                |===================================================                                                                     |  43%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |=====================================================                                                                   |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |========================================================                                                                |  46%  |                                                                                                                                |========================================================                                                                |  47%  |                                                                                                                                |=========================================================                                                               |  48%  |                                                                                                                                |==========================================================                                                              |  49%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |===============================================================                                                         |  53%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |================================================================                                                        |  54%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |====================================================================                                                    |  56%  |                                                                                                                                |====================================================================                                                    |  57%  |                                                                                                                                |=====================================================================                                                   |  58%  |                                                                                                                                |======================================================================                                                  |  59%  |                                                                                                                                |=======================================================================                                                 |  59%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |==========================================================================                                              |  62%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |===========================================================================                                             |  63%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |=============================================================================                                           |  64%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |=================================================================================                                       |  67%  |                                                                                                                                |=================================================================================                                       |  68%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  72%  |                                                                                                                                |=======================================================================================                                 |  72%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |=========================================================================================                               |  74%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |=============================================================================================                           |  77%  |                                                                                                                                |=============================================================================================                           |  78%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |===============================================================================================                         |  79%  |                                                                                                                                |================================================================================================                        |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |===================================================================================================                     |  82%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  85%  |                                                                                                                                |========================================================================================================                |  86%  |                                                                                                                                |=========================================================================================================               |  87%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |==========================================================================================================              |  89%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |==============================================================================================================          |  91%  |                                                                                                                                |==============================================================================================================          |  92%  |                                                                                                                                |===============================================================================================================         |  93%  |                                                                                                                                |================================================================================================================        |  93%  |                                                                                                                                |================================================================================================================        |  94%  |                                                                                                                                |=================================================================================================================       |  94%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |====================================================================================================================    |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |=====================================================================================================================   |  97%  |                                                                                                                                |=====================================================================================================================   |  98%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================  |  99%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |========================================================================================================================| 100%
```

```r
wa_roads = roads(state='WA',county = c('Clark'))  %>%
  st_transform(4326)
```

```
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   1%  |                                                                                                                                |==                                                                                                                      |   2%  |                                                                                                                                |====                                                                                                                    |   3%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |=====                                                                                                                   |   5%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |========                                                                                                                |   7%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |===========                                                                                                             |  10%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |==============                                                                                                          |  11%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |===============                                                                                                         |  13%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |====================                                                                                                    |  16%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |======================                                                                                                  |  18%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |===========================                                                                                             |  22%  |                                                                                                                                |===========================                                                                                             |  23%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |=============================                                                                                           |  25%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |================================                                                                                        |  27%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |=================================                                                                                       |  28%  |                                                                                                                                |==================================                                                                                      |  29%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  30%  |                                                                                                                                |======================================                                                                                  |  31%  |                                                                                                                                |======================================                                                                                  |  32%  |                                                                                                                                |=======================================                                                                                 |  32%  |                                                                                                                                |========================================                                                                                |  34%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  37%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |==================================================                                                                      |  42%  |                                                                                                                                |====================================================                                                                    |  43%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |=====================================================                                                                   |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |========================================================                                                                |  46%  |                                                                                                                                |========================================================                                                                |  47%  |                                                                                                                                |=========================================================                                                               |  48%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |===============================================================                                                         |  53%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |====================================================================                                                    |  57%  |                                                                                                                                |=====================================================================                                                   |  57%  |                                                                                                                                |======================================================================                                                  |  58%  |                                                                                                                                |=======================================================================                                                 |  59%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |===========================================================================                                             |  63%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |=============================================================================                                           |  64%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |==================================================================================                                      |  69%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  72%  |                                                                                                                                |=======================================================================================                                 |  72%  |                                                                                                                                |=======================================================================================                                 |  73%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |========================================================================================                                |  74%  |                                                                                                                                |=========================================================================================                               |  74%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  76%  |                                                                                                                                |=============================================================================================                           |  78%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |===============================================================================================                         |  79%  |                                                                                                                                |================================================================================================                        |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  81%  |                                                                                                                                |===================================================================================================                     |  82%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |=========================================================================================================               |  87%  |                                                                                                                                |=========================================================================================================               |  88%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |==============================================================================================================          |  92%  |                                                                                                                                |===============================================================================================================         |  93%  |                                                                                                                                |================================================================================================================        |  94%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |===================================================================================================================     |  95%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |=====================================================================================================================   |  97%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================  |  99%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |========================================================================================================================| 100%
```

```r
#Binding sf objects is still a little wonky - have to reassert as sf column and object
bound_roads = bind_rows(
  or_roads %>% as_tibble(),
  wa_roads %>% as_tibble()
) %>%
  mutate(geometry = st_sfc(geometry,crs=4326)) %>%
  st_as_sf() %>%
  st_transform(2269) 

#This will take 30 seconds or so, road data is big!
ggplot()+
  geom_sf(data = bound_roads,color='red')+
  geom_sf(data = simp_pdx_ua,color='black',size=1,
          #Want to have no fill to see roads through polygon
          fill=NA)
```

![plot of chunk tigris](figure/tigris-1.png)

```r
#I was going to do the intersection with the actual boundaries, but it was taking a few minutes, so not great for an example. You can do on your own! I did with the convex hull instead. 
# sub_bound_roads  = bound_roads %>%
#   st_intersection(simp_pdx_ua)

#Sometimes if you are doing complex spatial subsetting, you can speed it up using convex hulls
pdx_hull = portland_urban_area %>%
  st_transform(2269) %>%
  st_convex_hull()

#Here is what a convex hull looks like
ggplot()+
  geom_sf(data = portland_urban_area,color='black',size=1,
          #Want to have no fill to see roads through polygon
          fill=NA)+
  geom_sf(data= pdx_hull,color='blue',size=1,fill=NA)
```

![plot of chunk tigris](figure/tigris-2.png)

```r
#Codebook for MTFCC feature in TIGER geographies here: https://www2.census.gov/geo/pdfs/reference/mtfccs2019.pdf
big_roads = bound_roads %>%
  filter(MTFCC %in% c('S1100', #Primary roads
                      'S1200')) %>% #Secondary roads
  st_cast('LINESTRING') %>%
  st_intersection(pdx_hull %>%
                    select(geometry)) %>% 
  mutate(sf_type = map_chr(geometry,~class(.x)[2])) %>%
  filter(sf_type=='LINESTRING') %>%
  st_cast('LINESTRING')

#Grab Places to subset as well
orwa_places = places(state=c('OR','WA'))
```

```
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   1%  |                                                                                                                                |===                                                                                                                     |   2%  |                                                                                                                                |===                                                                                                                     |   3%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |========                                                                                                                |   6%  |                                                                                                                                |=========                                                                                                               |   8%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |================                                                                                                        |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |=====================                                                                                                   |  17%  |                                                                                                                                |======================                                                                                                  |  18%  |                                                                                                                                |======================                                                                                                  |  19%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |===========================                                                                                             |  22%  |                                                                                                                                |============================                                                                                            |  24%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |==================================                                                                                      |  29%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  31%  |                                                                                                                                |=======================================                                                                                 |  32%  |                                                                                                                                |========================================                                                                                |  34%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |============================================                                                                            |  37%  |                                                                                                                                |=============================================                                                                           |  37%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |==============================================                                                                          |  39%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |===================================================                                                                     |  42%  |                                                                                                                                |====================================================                                                                    |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |=========================================================                                                               |  47%  |                                                                                                                                |==========================================================                                                              |  48%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |===============================================================                                                         |  52%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |=====================================================================                                                   |  57%  |                                                                                                                                |======================================================================                                                  |  58%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |============================================================================                                            |  63%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |=================================================================================                                       |  67%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |===================================================================================                                     |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  72%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |=========================================================================================                               |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |==============================================================================================                          |  78%  |                                                                                                                                |===============================================================================================                         |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |========================================================================================================                |  87%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |==============================================================================================================          |  92%  |                                                                                                                                |===============================================================================================================         |  93%  |                                                                                                                                |================================================================================================================        |  93%  |                                                                                                                                |=================================================================================================================       |  94%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |===================================================================================================================     |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |========================================================================================================================| 100%
##   |                                                                                                                                |                                                                                                                        |   0%  |                                                                                                                                |=                                                                                                                       |   1%  |                                                                                                                                |==                                                                                                                      |   2%  |                                                                                                                                |===                                                                                                                     |   3%  |                                                                                                                                |====                                                                                                                    |   4%  |                                                                                                                                |=====                                                                                                                   |   4%  |                                                                                                                                |======                                                                                                                  |   5%  |                                                                                                                                |=======                                                                                                                 |   6%  |                                                                                                                                |=========                                                                                                               |   7%  |                                                                                                                                |==========                                                                                                              |   8%  |                                                                                                                                |==========                                                                                                              |   9%  |                                                                                                                                |===========                                                                                                             |   9%  |                                                                                                                                |============                                                                                                            |  10%  |                                                                                                                                |=============                                                                                                           |  11%  |                                                                                                                                |==============                                                                                                          |  12%  |                                                                                                                                |===============                                                                                                         |  12%  |                                                                                                                                |================                                                                                                        |  13%  |                                                                                                                                |=================                                                                                                       |  14%  |                                                                                                                                |==================                                                                                                      |  15%  |                                                                                                                                |===================                                                                                                     |  16%  |                                                                                                                                |====================                                                                                                    |  17%  |                                                                                                                                |=====================                                                                                                   |  18%  |                                                                                                                                |======================                                                                                                  |  19%  |                                                                                                                                |=======================                                                                                                 |  19%  |                                                                                                                                |========================                                                                                                |  20%  |                                                                                                                                |=========================                                                                                               |  21%  |                                                                                                                                |==========================                                                                                              |  22%  |                                                                                                                                |===========================                                                                                             |  22%  |                                                                                                                                |============================                                                                                            |  23%  |                                                                                                                                |============================                                                                                            |  24%  |                                                                                                                                |=============================                                                                                           |  24%  |                                                                                                                                |==============================                                                                                          |  25%  |                                                                                                                                |===============================                                                                                         |  26%  |                                                                                                                                |================================                                                                                        |  27%  |                                                                                                                                |=================================                                                                                       |  27%  |                                                                                                                                |==================================                                                                                      |  28%  |                                                                                                                                |===================================                                                                                     |  29%  |                                                                                                                                |====================================                                                                                    |  30%  |                                                                                                                                |=====================================                                                                                   |  31%  |                                                                                                                                |======================================                                                                                  |  32%  |                                                                                                                                |=======================================                                                                                 |  33%  |                                                                                                                                |========================================                                                                                |  34%  |                                                                                                                                |=========================================                                                                               |  34%  |                                                                                                                                |==========================================                                                                              |  35%  |                                                                                                                                |===========================================                                                                             |  36%  |                                                                                                                                |=============================================                                                                           |  37%  |                                                                                                                                |==============================================                                                                          |  38%  |                                                                                                                                |==============================================                                                                          |  39%  |                                                                                                                                |===============================================                                                                         |  39%  |                                                                                                                                |================================================                                                                        |  40%  |                                                                                                                                |=================================================                                                                       |  41%  |                                                                                                                                |==================================================                                                                      |  41%  |                                                                                                                                |===================================================                                                                     |  42%  |                                                                                                                                |====================================================                                                                    |  43%  |                                                                                                                                |=====================================================                                                                   |  44%  |                                                                                                                                |======================================================                                                                  |  45%  |                                                                                                                                |=======================================================                                                                 |  46%  |                                                                                                                                |========================================================                                                                |  46%  |                                                                                                                                |========================================================                                                                |  47%  |                                                                                                                                |=========================================================                                                               |  47%  |                                                                                                                                |=========================================================                                                               |  48%  |                                                                                                                                |==========================================================                                                              |  49%  |                                                                                                                                |===========================================================                                                             |  49%  |                                                                                                                                |============================================================                                                            |  50%  |                                                                                                                                |=============================================================                                                           |  51%  |                                                                                                                                |==============================================================                                                          |  52%  |                                                                                                                                |================================================================                                                        |  53%  |                                                                                                                                |=================================================================                                                       |  54%  |                                                                                                                                |==================================================================                                                      |  55%  |                                                                                                                                |===================================================================                                                     |  56%  |                                                                                                                                |====================================================================                                                    |  56%  |                                                                                                                                |=====================================================================                                                   |  57%  |                                                                                                                                |======================================================================                                                  |  58%  |                                                                                                                                |=======================================================================                                                 |  59%  |                                                                                                                                |========================================================================                                                |  60%  |                                                                                                                                |=========================================================================                                               |  61%  |                                                                                                                                |==========================================================================                                              |  62%  |                                                                                                                                |===========================================================================                                             |  62%  |                                                                                                                                |===========================================================================                                             |  63%  |                                                                                                                                |============================================================================                                            |  64%  |                                                                                                                                |=============================================================================                                           |  64%  |                                                                                                                                |==============================================================================                                          |  65%  |                                                                                                                                |===============================================================================                                         |  66%  |                                                                                                                                |================================================================================                                        |  67%  |                                                                                                                                |==================================================================================                                      |  68%  |                                                                                                                                |===================================================================================                                     |  69%  |                                                                                                                                |====================================================================================                                    |  70%  |                                                                                                                                |=====================================================================================                                   |  71%  |                                                                                                                                |======================================================================================                                  |  71%  |                                                                                                                                |=======================================================================================                                 |  72%  |                                                                                                                                |========================================================================================                                |  73%  |                                                                                                                                |=========================================================================================                               |  74%  |                                                                                                                                |==========================================================================================                              |  75%  |                                                                                                                                |===========================================================================================                             |  76%  |                                                                                                                                |============================================================================================                            |  77%  |                                                                                                                                |=============================================================================================                           |  78%  |                                                                                                                                |==============================================================================================                          |  79%  |                                                                                                                                |===============================================================================================                         |  79%  |                                                                                                                                |================================================================================================                        |  80%  |                                                                                                                                |=================================================================================================                       |  81%  |                                                                                                                                |==================================================================================================                      |  82%  |                                                                                                                                |====================================================================================================                    |  83%  |                                                                                                                                |====================================================================================================                    |  84%  |                                                                                                                                |=====================================================================================================                   |  84%  |                                                                                                                                |======================================================================================================                  |  85%  |                                                                                                                                |=======================================================================================================                 |  86%  |                                                                                                                                |========================================================================================================                |  86%  |                                                                                                                                |=========================================================================================================               |  87%  |                                                                                                                                |==========================================================================================================              |  88%  |                                                                                                                                |===========================================================================================================             |  89%  |                                                                                                                                |============================================================================================================            |  90%  |                                                                                                                                |=============================================================================================================           |  91%  |                                                                                                                                |==============================================================================================================          |  92%  |                                                                                                                                |===============================================================================================================         |  93%  |                                                                                                                                |================================================================================================================        |  94%  |                                                                                                                                |=================================================================================================================       |  94%  |                                                                                                                                |==================================================================================================================      |  95%  |                                                                                                                                |===================================================================================================================     |  96%  |                                                                                                                                |====================================================================================================================    |  97%  |                                                                                                                                |======================================================================================================================  |  98%  |                                                                                                                                |======================================================================================================================  |  99%  |                                                                                                                                |======================================================================================================================= |  99%  |                                                                                                                                |========================================================================================================================| 100%
```

```r
pdx_places = orwa_places %>%
  st_transform(2269) %>%
  st_intersection(simp_pdx_ua)


leaflet() %>%
  addProviderTiles('CartoDB.Positron') %>%
  #You can put a polygon on a leaflet map as a polyline to only show boundary and not area
  addPolylines(data = simp_pdx_ua %>% st_transform(4326),
               color='black',weight=2) %>%
  addPolygons(data = pdx_places %>% st_transform(4326),
              fillColor='red',fillOpacity = 0.5,color='white',
              weight=1,label=~NAMELSAD,
              #Highlight options helpful when you have overlapping objects
              highlightOptions = highlightOptions(weight=3,sendToBack = TRUE,
                                                  fillOpacity = 0.8)) %>%
  addPolylines(data=big_roads %>% st_transform(4326),
               color='blue',weight=~ifelse(MTFCC=='S1200',4,2),
               label=~FULLNAME)
```

```
## Error in file(con, "rb"): cannot open the connection
```

# Census Data Querying with `tidycensus`

*__Acknowledgment:__ This portion of this module heavily draws upon, including direct copy-paste of markdown content, the vignettes developed for the `tidycensus` package, available on the package [documentation website](https://walker-data.com/tidycensus/). *

Most of the time you are not using census geographies for the sole purpose of mapping the geographies themselves -- these geographies are tied to a wealth of statistics available from the U.S. Census Bureau. The product NN uses most often from the U.S. Census Bureau is the American Community Survey -- an annual sample survey (a statistically representative sub-sample of the population) conducted with a much more detailed survey than the Census itself (conducted on the entire U.S. population). We typically use the 5-year version, which pools samples from the previous 5 years on a rolling basis to achieve higher accuracy. The 1-year version has a smaller sample to work with so has a larger margin of error, but allows for understanding changes in trends at a higher temporal resolution. For demographic mapping, we generally recommend using the 5-year version. 

## Basic Usage

To get started working with __tidycensus__, users should load the package along with the __tidyverse__ package, and set their Census API key.  A key can be obtained from <http://api.census.gov/data/key_signup.html>.  


```r
library(tidycensus)
library(tidyverse)
census_api_key("04976a4a378107d2fb53acdbde84d0aad121cb10")
```

```
## To install your API key for use in future sessions, run this function with `install = TRUE`.
```

There are two major functions implemented in __tidycensus__: `get_decennial()`, which grants access to the 1990, 2000, and 2010 decennial US Census APIs, and `get_acs()`, which grants access to the 5-year American Community Survey APIs. As mentioned, we will be focusing on `get_acs`. 

## Searching for variables

Getting variables from the Census or ACS requires knowing the variable ID - and there are thousands of these IDs across the different Census files.  To rapidly search for variables, use the `load_variables()` function.  The function takes two required arguments: the year of the Census or endyear of the ACS sample, and the dataset - one of `"sf1"`, `"sf3"`, or `"acs5"`. For ideal functionality, I recommend assigning the result of this function to a variable, setting `cache = TRUE` to store the result on your computer for future access, and using the `View` function in RStudio to interactively browse for variables.  


```r
v17 <- load_variables(2017, "acs5")
View(v17)
```

<img src=graphics/census_variables.png style="width: 100%">

By filtering for "median age" I can quickly view the variable IDs that correspond to my query.  

## Working with ACS data

American Community Survey data differ from decennial Census data in that ACS data are based on an annual sample of approximately 3 million households, rather than a more complete enumeration of the US population.  In turn, ACS data points are __estimates__ characterized by a __margin of error__.  __tidycensus__ will always return the estimate and margin of error together for any requested variables when using `get_acs()`.  In turn, when requesting ACS data with __tidycensus__, it is not necessary to specify the `"E"` or `"M"` suffix for a variable name.  Let's fetch median household income data from the 2014-2018 ACS for counties in Vermont. 


```r
vt <- get_acs(geography = "county", 
              variables = c(medincome = "B19013_001"), 
              state = "VT", 
              year = 2018)
```

```
## Getting data from the 2014-2018 5-year ACS
```

```
## Using FIPS code '50' for state 'VT'
```

```r
vt
```

```
## # A tibble: 14 x 5
##    GEOID NAME                       variable  estimate   moe
##    <chr> <chr>                      <chr>        <dbl> <dbl>
##  1 50001 Addison County, Vermont    medincome    65093  2424
##  2 50003 Bennington County, Vermont medincome    53040  2307
##  3 50005 Caledonia County, Vermont  medincome    49348  1842
##  4 50007 Chittenden County, Vermont medincome    69896  2132
##  5 50009 Essex County, Vermont      medincome    41045  2661
##  6 50011 Franklin County, Vermont   medincome    64258  1568
##  7 50013 Grand Isle County, Vermont medincome    69583  5812
##  8 50015 Lamoille County, Vermont   medincome    60365  3915
##  9 50017 Orange County, Vermont     medincome    60159  2361
## 10 50019 Orleans County, Vermont    medincome    47915  2193
## 11 50021 Rutland County, Vermont    medincome    54973  1754
## 12 50023 Washington County, Vermont medincome    62108  2065
## 13 50025 Windham County, Vermont    medincome    52659  1706
## 14 50027 Windsor County, Vermont    medincome    58303  1576
```

The output of `get_acs` returns `estimate` and `moe` columns for the ACS estimate and margin of error, respectively.  `moe` represents the default 90 percent confidence level around the estimate; this can be changed to 95 or 99 percent with the `moe_level` parameter in `get_acs` if desired. As we have the margin of error, we can visualize the uncertainty around the estimate: 


```r
vt %>%
  mutate(NAME = gsub(" County, Vermont", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Vermont",
       subtitle = "2014-2018 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")
```

![plot of chunk unnamed-chunk-4](figure/unnamed-chunk-4-1.png)

## Adding Geometry

If requested, __tidycensus__ can return simple feature geometry for geographic units along with variables from the decennial US Census or American Community survey.  By setting `geometry = TRUE` in a __tidycensus__ function call, __tidycensus__ will use the __tigris__ package to retrieve the corresponding geographic dataset from the US Census Bureau and pre-merge it with the tabular data obtained from the Census API.  As of tidycensus version 0.9.9.2, `geometry = TRUE` is supported for all geographies currently available in the package.  Of course you can also just query the geographies yourself from `tigris`, and join data on the `GEOID` as needed. 

The following example shows median household income from the 2014-2018 ACS for Census tracts in Orange County, California: 


```r
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
orange <- get_acs(state = "CA", county = "Orange", geography = "tract", 
                  variables = "B19013_001", geometry = TRUE)
```

```
## Getting data from the 2014-2018 5-year ACS
```

```
## Using FIPS code '06' for state 'CA'
```

```
## Using FIPS code '059' for 'Orange County'
```

```r
head(orange)
```

```
## Simple feature collection with 6 features and 5 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -117.9766 ymin: 33.85427 xmax: -117.816 ymax: 33.93912
## geographic CRS: NAD83
##         GEOID                                           NAME   variable estimate   moe                       geometry
## 1 06059001202  Census Tract 12.02, Orange County, California B19013_001    65132 10761 MULTIPOLYGON (((-117.9505 3...
## 2 06059001802  Census Tract 18.02, Orange County, California B19013_001    52701  9284 MULTIPOLYGON (((-117.9766 3...
## 3 06059011101 Census Tract 111.01, Orange County, California B19013_001    69531 15506 MULTIPOLYGON (((-117.9502 3...
## 4 06059011710 Census Tract 117.10, Orange County, California B19013_001   104879 14644 MULTIPOLYGON (((-117.8723 3...
## 5 06059011721 Census Tract 117.21, Orange County, California B19013_001    51042 10814 MULTIPOLYGON (((-117.8799 3...
## 6 06059021820 Census Tract 218.20, Orange County, California B19013_001   144112 18641 MULTIPOLYGON (((-117.8437 3...
```

Our object `orange` looks much like the basic __tidycensus__ output, but with a `geometry` list-column describing the geometry of each feature, using the geographic coordinate system NAD 1983 (EPSG: 4269) which is the default for Census shapefiles.  __tidycensus__ uses the Census [cartographic boundary shapefiles](https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html) for faster processing; if you prefer the TIGER/Line shapefiles, set `cb = FALSE` in the function call. 

As the dataset is in a tidy format, it can be quickly visualized with the `geom_sf` functionality currently in the development version of __ggplot2__: 


```r
orange %>%
  ggplot(aes(fill = estimate)) + 
  geom_sf(color = NA) + 
  coord_sf(crs = 26911) + 
  scale_fill_viridis_c(option = "magma") 
```

![plot of chunk unnamed-chunk-6](figure/unnamed-chunk-6-1.png)

Please note that the UTM Zone 11N coordinate system (`26911`) is appropriate for Southern California but may not be for your area of interest.  

## Example - Part 2

Let's try to map the median income of all of the CDPs we mapped in the first part of this module. 


```r
library(scales)

pdx_cdp_med_income = get_acs(state=c('OR','WA'),geography = 'place',
                             variables = c(medincome = "B19013_001")) %>%
  #Filtering for GEOIDs in PDX Places
  filter(GEOID %in% pdx_places$GEOID)

#Joining ACS data to shape
pdx_cdp_mi_shape = pdx_places %>%
  left_join(pdx_cdp_med_income %>%
              select(GEOID,estimate))

income_pal = colorNumeric(
  #Scales package lets you access color brewer palettes
  palette = brewer_pal(palette = 'Greens')(5),
  domain =  pdx_cdp_mi_shape$estimate
)

leaflet() %>%
  addProviderTiles('CartoDB.Positron') %>%
  #You can put a polygon on a leaflet map as a polyline to only show boundary and not area
  addPolylines(data = simp_pdx_ua %>% st_transform(4326),
               color='black',weight=2) %>%
  addPolygons(data = pdx_cdp_mi_shape %>% st_transform(4326),
              fillColor=~income_pal(estimate),fillOpacity = 0.5,color='white',
              weight=1,label=~paste0(NAMELSAD,': ',dollar(estimate)),
              highlightOptions = highlightOptions(weight=3,sendToBack = TRUE,
                                                  fillOpacity = 0.8)) %>%
  addLegend(pal = income_pal,values =pdx_cdp_mi_shape$estimate,
            labFormat = labelFormat(prefix = '$'),title = 'Median<br>Household<br>Income')
```

```
## Warning in normalizePath(path.expand(path), winslash, mustWork): path[1]="webshot77c325c2282.png": The system cannot find the file
## specified
```

```
## Warning in file(con, "rb"): cannot open file 'C:
## \Users\blancb\AppData\Local\Temp\RtmpOyRHcg\file77c23fd6afb\webshot77c325c2282.png': No such file or directory
```

```
## Error in file(con, "rb"): cannot open the connection
```

# Downloading and Aggregating LODES data with `lehdr`

*__Acknowledgment:__ This portion of this module heavily draws upon, including direct copy-paste of markdown content, the vignettes developed for the `lehdr` package, available on the package [documentation website.](https://jamgreen.github.io/lehdr/articles/getting_started.html)*

In addition the residential-based statistics the U.S. Census Bureau provides through ACS (and the Census itself), another annual data product they offer is the Longitudinal Employer Household Dynamics (LEHD) [Origin Destination Employment Statistics](https://lehd.ces.census.gov/data/#lodes) (LODES, for short!) data set. There are other LEHD data products offered that do not yet appear to have an R wrapper, but the package we will be looking at ([`lehdr`](https://jamgreen.github.io/lehdr/index.html)) is in development. 

The LODES data set is based on survey data as well as residential location data (from the ACS and the Census) and workplace location data that the Census Bureau and the Bureau of Labor Statistics (BLS) collect. It is often used in work at NN to understand employment locations as well as origin-destination patterns between home locations and employment locations. As it is a national data set, it is not as well attuned to local dynamics as the local MPO would be in their travel surveying efforts, so I would always defer to recent travel survey and modeling data from an MPO if that is available. That said, LODES is a great product for where there is no travel survey coverage, or a travel survey has not been conducted in some time. It is provided at the Census Block level, and so as you can guess the datasets can get pretty large! Which can make Excel a bit clunky for the job depending on the area you are looking at, but R has no problem handling! 

## Installation

`lehdr` has not yet been submitted to CRAN so installing using devtools is required. 


```r
install.packages('devtools')
devtools::install_github("jamgreen/lehdr")
```

```r
library(lehdr)
```

## Usage
This first example pulls the Oregon (`state = "or"`) 2014 (`year = 2014`), origin-destination (`lodes_type = "od"`), all jobs including private primary, secondary, and Federal (`job_type = "JT01"`), all jobs across ages, earnings, and industry (`segment = "S000"`), aggregated at the Census Tract level rather than the default Census Block (`agg_geo = "tract"`).

__Note: LODES data is large, so some of these steps will take a minute or more to run.__


```r
or_od <- grab_lodes(state = "or", year = 2014, lodes_type = "od", job_type = "JT01", 
           segment = "S000", state_part = "main", agg_geo = "tract")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/or_od_main_JT01_2014.csv.gz
## Reading now...
```

```r
head(or_od)
```

```
## # A tibble: 6 x 14
##    year state w_tract     h_tract      S000  SA01  SA02  SA03  SE01  SE02  SE03  SI01  SI02  SI03
##   <dbl> <chr> <chr>       <chr>       <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  2014 OR    41001950100 41001950100    89     6    37    46    35    30    24    21    11    57
## 2  2014 OR    41001950100 41001950200    35     2    25     8     6    13    16     1     4    30
## 3  2014 OR    41001950100 41001950300    23     6    12     5     5    12     6     7     3    13
## 4  2014 OR    41001950100 41001950400    20     0    17     3     4     4    12     4     2    14
## 5  2014 OR    41001950100 41001950500    24     8    10     6     3    12     9     6     6    12
## 6  2014 OR    41001950100 41001950600    10     3     5     2     4     5     1     2     0     8
```

The package can be used to retrieve multiple states and years at the same time by creating a vector or list. This second example pulls the Oregon AND Rhode Island (`state = c("or", "ri")`) for 2013 and 2014 (`year = c(2013, 2014)` or `year = 2013:2014`).

```r
or_ri_od <- grab_lodes(state = c("or", "ri"), year = c(2013, 2014),
                       lodes_type = "od", job_type = "JT01", 
           segment = "S000", state_part = "main", agg_geo = "tract")     
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/or_od_main_JT01_2013.csv.gz
## Reading now...
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/ri_od_main_JT01_2013.csv.gz
## Reading now...
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/or_od_main_JT01_2014.csv.gz
## Reading now...
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/ri_od_main_JT01_2014.csv.gz
## Reading now...
```

```r
head(or_ri_od)
```

```
## # A tibble: 6 x 14
##   year  state w_tract     h_tract      S000  SA01  SA02  SA03  SE01  SE02  SE03  SI01  SI02  SI03
##   <chr> <chr> <chr>       <chr>       <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 2013  OR    41001950100 41001950100    80     4    39    37    25    30    25    25    11    44
## 2 2013  OR    41001950100 41001950200    27     4    15     8     8    11     8     3     7    17
## 3 2013  OR    41001950100 41001950300    11     1     5     5     6     3     2     1     0    10
## 4 2013  OR    41001950100 41001950400    21     3    14     4     5     8     8     4     1    16
## 5 2013  OR    41001950100 41001950500    27    12     8     7     4    15     8     8     1    18
## 6 2013  OR    41001950100 41001950600     4     1     2     1     2     0     2     0     0     4
```
Not all years are available for each state. To see all options for `lodes_type`, `job_type`, and `segment` and the availability for each state/year, please see the most recent LEHD Technical Document at https://lehd.ces.census.gov/data/lodes/LODES7/.

Other common uses might include retrieving Residential or Work Area Characteristics (`lodes_type = "rac"` or `lodes_type = "wac"` respectively), low income jobs (`segment = "SE01"`) or good producing jobs (`segment = "SI01"`). Other common geographies might include retrieving data at the Census Block level (`agg_geo = "block"`, not necessary as it is default) -- but see below for other aggregation levels.

## Additional Examples
### Adding at County level signifiers
The following examples loads work area characteristics (wac), then uses the work area geoid `w_geocode` to create a variable that is just the county `w_county_fips`. Similar transformations can be made on residence area characteristics (rac) by using the `h_geocode` variable. Both variables are available in origin-destination (od) datasets and with od, one would need to set a `h_county_fips` and on `w_county_fips`.

```r
md_rac <- grab_lodes(state = "md", year = 2015, lodes_type = "wac", job_type = "JT01", segment = "S000")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_wac_S000_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_rac)
```

```
## # A tibble: 6 x 55
##   w_geocode  C000  CA01  CA02  CA03  CE01  CE02  CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07 CNS08 CNS09 CNS10 CNS11 CNS12
##   <chr>     <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 24001000~     7     3     3     1     4     3     0     0     0     0     0     0     0     7     0     0     0     0     0
## 2 24001000~     1     0     1     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0
## 3 24001000~    10     2     3     5     7     3     0     0     0     0     0     0     0    10     0     0     0     0     0
## 4 24001000~     2     0     2     0     0     1     1     0     0     0     0     0     0     0     0     0     0     0     0
## 5 24001000~     8     4     4     0     7     1     0     0     0     0     0     0     0     8     0     0     0     0     0
## 6 24001000~     2     0     2     0     0     2     0     0     0     0     0     0     0     0     2     0     0     0     0
## # ... with 35 more variables: CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>, CNS18 <dbl>, CNS19 <dbl>,
## #   CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>, CT01 <dbl>, CT02 <dbl>, CD01 <dbl>,
## #   CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>, CFA01 <dbl>, CFA02 <dbl>, CFA03 <dbl>, CFA04 <dbl>, CFA05 <dbl>,
## #   CFS01 <dbl>, CFS02 <dbl>, CFS03 <dbl>, CFS04 <dbl>, CFS05 <dbl>, createdate <chr>, year <dbl>, state <chr>
```

```r
md_rac_county <- md_rac %>% mutate(w_county_fips = str_sub(w_geocode, 1, 5))
head(md_rac_county)
```

```
## # A tibble: 6 x 56
##   w_geocode  C000  CA01  CA02  CA03  CE01  CE02  CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07 CNS08 CNS09 CNS10 CNS11 CNS12
##   <chr>     <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 24001000~     7     3     3     1     4     3     0     0     0     0     0     0     0     7     0     0     0     0     0
## 2 24001000~     1     0     1     0     0     1     0     0     0     0     0     0     0     0     0     0     0     0     0
## 3 24001000~    10     2     3     5     7     3     0     0     0     0     0     0     0    10     0     0     0     0     0
## 4 24001000~     2     0     2     0     0     1     1     0     0     0     0     0     0     0     0     0     0     0     0
## 5 24001000~     8     4     4     0     7     1     0     0     0     0     0     0     0     8     0     0     0     0     0
## 6 24001000~     2     0     2     0     0     2     0     0     0     0     0     0     0     0     2     0     0     0     0
## # ... with 36 more variables: CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>, CNS18 <dbl>, CNS19 <dbl>,
## #   CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>, CT01 <dbl>, CT02 <dbl>, CD01 <dbl>,
## #   CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>, CFA01 <dbl>, CFA02 <dbl>, CFA03 <dbl>, CFA04 <dbl>, CFA05 <dbl>,
## #   CFS01 <dbl>, CFS02 <dbl>, CFS03 <dbl>, CFS04 <dbl>, CFS05 <dbl>, createdate <chr>, year <dbl>, state <chr>,
## #   w_county_fips <chr>
```

### Aggregating at the County level
To aggregate at the county level, continuing the above example, we must also drop the original lock geoid `w_geocode`, group by our new variable `w_county_fips` and our existing variables `year` and `createdate`, then aggregate the remaining numeric variables.

```r
md_rac_county <- md_rac %>% mutate(w_county_fips = str_sub(w_geocode, 1, 5)) %>% 
  select(-"w_geocode") %>%
  group_by(w_county_fips, state, year, createdate) %>% 
  summarise_if(is.numeric, sum)
head(md_rac_county)
```

```
## # A tibble: 6 x 55
## # Groups:   w_county_fips, state, year [6]
##   w_county_fips state  year createdate   C000  CA01   CA02  CA03  CE01   CE02   CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07
##   <chr>         <chr> <dbl> <chr>       <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1 24001         MD     2015 20190826    25887  5653  13801  6433  5938  11081   8868     1   103    47   891  2434   546  2882
## 2 24003         MD     2015 20190826   237881 57186 125917 54778 44280  72498 121103   133    74   422 15861 12895 12147 31210
## 3 24005         MD     2015 20190826   345823 82049 180737 83037 68082 112227 165514   413    86  1304 21885 13846 12095 45825
## 4 24009         MD     2015 20190826    20063  5119  10381  4563  4539   6775   8749    19     7  1034  2340   569   451  2373
## 5 24011         MD     2015 20190826     7939  1567   4179  2193  1346   3293   3300   130     0   152   658  1006   354   901
## 6 24013         MD     2015 20190826    52618 13124  26078 13416 11985  18843  21790   411    19    26  5482  3965  2792  7403
## # ... with 37 more variables: CNS08 <dbl>, CNS09 <dbl>, CNS10 <dbl>, CNS11 <dbl>, CNS12 <dbl>, CNS13 <dbl>, CNS14 <dbl>,
## #   CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>, CNS18 <dbl>, CNS19 <dbl>, CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>,
## #   CR05 <dbl>, CR07 <dbl>, CT01 <dbl>, CT02 <dbl>, CD01 <dbl>, CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>,
## #   CFA01 <dbl>, CFA02 <dbl>, CFA03 <dbl>, CFA04 <dbl>, CFA05 <dbl>, CFS01 <dbl>, CFS02 <dbl>, CFS03 <dbl>, CFS04 <dbl>,
## #   CFS05 <dbl>
```

Alternatively, this functionality is also built-in to the package and advisable for origin-destination grabs. Here include an argument to aggregate at the County level (`agg_geo = "county"`):


```r
md_rac_county <- grab_lodes(state = "md", year = 2015, lodes_type = "rac", job_type = "JT01", 
           segment = "S000", agg_geo = "county")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_rac_S000_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_rac_county)
```

```
## # A tibble: 6 x 44
##    year state h_county   C000  CA01   CA02  CA03  CE01   CE02   CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07 CNS08 CNS09 CNS10
##   <dbl> <chr> <chr>     <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  2015 MD    24001     24683  5488  13029  6166  5598  10294   8791    51   140    89  1024  2331   674  2792   665   558   650
## 2  2015 MD    24003    239454 51186 131373 56895 38476  63599 137379   214    84  1034 16683  9538 11116 26162  8120  4606  8244
## 3  2015 MD    24005    371927 79756 198239 93932 62678 112647 196602   426    99  1760 19332 16009 14179 38215 12247  6869 18479
## 4  2015 MD    24009     32868  7565  17830  7473  5643   9029  18196    48    11   780  3493  1023   971  3447   952   421   709
## 5  2015 MD    24011     14935  3285   7827  3823  2800   5829   6306   238    13   128  1163  1161   748  1979   704   191   372
## 6  2015 MD    24013     80257 17028  42594 20635 13427  21671  45159   347    31   384  6932  4904  4031  8698  1920  1348  3573
## # ... with 24 more variables: CNS11 <dbl>, CNS12 <dbl>, CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>,
## #   CNS18 <dbl>, CNS19 <dbl>, CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>, CT01 <dbl>,
## #   CT02 <dbl>, CD01 <dbl>, CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>
```

### Aggregating Origin-Destination 
As mentioned above, aggregating origin-destination is built-in. This takes care of aggregation on both the `h_geocode` and `w_geocode` variables:

```r
md_od_county <- grab_lodes(state = "md", year = 2015, lodes_type = "od", job_type = "JT01", 
           segment = "S000", agg_geo = "county", state_part = "main")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_od_main_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_od_county)
```

```
## # A tibble: 6 x 14
##    year state w_county h_county  S000  SA01  SA02  SA03  SE01  SE02  SE03  SI01  SI02  SI03
##   <dbl> <chr> <chr>    <chr>    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  2015 MD    24001    24001    16347  3533  8570  4244  3911  7249  5187  1908  2233 12206
## 2  2015 MD    24001    24003      171    48    78    45    53    51    67    10    53   108
## 3  2015 MD    24001    24005      272    68   140    64    73    92   107     7   101   164
## 4  2015 MD    24001    24009       29    13     8     8    15     7     7     1     7    21
## 5  2015 MD    24001    24011        9     1     7     1     2     3     4     0     4     5
## 6  2015 MD    24001    24013       74    22    41    11    24    22    28     2    31    41
```

### Aggregating at Block Group, Tract, or State level
Similarly, built-in functions exist to group at Block Group, Tract, County, and State levels. County was demonstrated above. All require setting the `agg_geo` argument. This aggregation works for all three LODES types.


```r
md_rac_bg <- grab_lodes(state = "md", year = 2015, lodes_type = "rac", job_type = "JT01", 
           segment = "S000", agg_geo = "bg")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_rac_S000_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_rac_bg)
```

```
## # A tibble: 6 x 44
##    year state h_bg      C000  CA01  CA02  CA03  CE01  CE02  CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07 CNS08 CNS09 CNS10 CNS11
##   <dbl> <chr> <chr>    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  2015 MD    2400100~   251    56   126    69    51   103    97     2     2     0    11    35     9    34    12     1    10     0
## 2  2015 MD    2400100~   452    90   242   120    91   183   178     3     6     2    24    52    12    58    14     6    17     2
## 3  2015 MD    2400100~   341    71   191    79    74   150   117     1     4     1    21    38    14    42    15     3     5     1
## 4  2015 MD    2400100~   294    51   157    86    52   124   118     1     2     1    11    46     5    24    10     2     9     2
## 5  2015 MD    2400100~   352    66   196    90    78   134   140     1     0     0    18    41     9    36    11     4     7     2
## 6  2015 MD    2400100~   550   119   286   145   105   244   201     1     2     0    27    64    24    48    16    13    12     4
## # ... with 23 more variables: CNS12 <dbl>, CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>, CNS18 <dbl>,
## #   CNS19 <dbl>, CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>, CT01 <dbl>, CT02 <dbl>,
## #   CD01 <dbl>, CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>
```

```r
md_rac_tract <- grab_lodes(state = "md", year = 2015, lodes_type = "rac", job_type = "JT01", 
           segment = "S000", agg_geo = "tract")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_rac_S000_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_rac_tract)
```

```
## # A tibble: 6 x 44
##    year state h_tract   C000  CA01  CA02  CA03  CE01  CE02  CE03 CNS01 CNS02 CNS03 CNS04 CNS05 CNS06 CNS07 CNS08 CNS09 CNS10 CNS11
##   <dbl> <chr> <chr>    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1  2015 MD    2400100~  1044   217   559   268   216   436   392     6    12     3    56   125    35   134    41    10    32     3
## 2  2015 MD    2400100~  1196   236   639   321   235   502   459     3     4     1    56   151    38   108    37    19    28     8
## 3  2015 MD    2400100~   945   206   493   246   225   395   325     3     1     1    43    77    29    96    26    18    27     4
## 4  2015 MD    2400100~  1134   228   598   308   282   466   386     0     5     5    43    95    29   130    28    32    33     8
## 5  2015 MD    2400100~   746   159   371   216   184   337   225     1     2     4    34    78    17    80    24    11    29     9
## 6  2015 MD    2400100~  1091   265   573   253   261   459   371     1     2     6    32    84    21   128    35    24    24     5
## # ... with 23 more variables: CNS12 <dbl>, CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>, CNS17 <dbl>, CNS18 <dbl>,
## #   CNS19 <dbl>, CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>, CT01 <dbl>, CT02 <dbl>,
## #   CD01 <dbl>, CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>
```

```r
md_rac_state <- grab_lodes(state = "md", year = 2015, lodes_type = "rac", job_type = "JT01", 
           segment = "S000", agg_geo = "state")
```

```
## Cached version of file found in C:\Users\blancb\AppData\Local\lehdr\lehdr\Cache/md_rac_S000_JT01_2015.csv.gz
## Reading now...
```

```r
head(md_rac_state)
```

```
## # A tibble: 1 x 44
##    year state h_state   C000   CA01   CA02   CA03   CE01   CE02   CE03 CNS01 CNS02 CNS03  CNS04  CNS05 CNS06  CNS07 CNS08 CNS09
##   <dbl> <chr> <chr>    <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl>  <dbl> <dbl> <dbl> <dbl>  <dbl>  <dbl> <dbl>  <dbl> <dbl> <dbl>
## 1  2015 MD    24      2.53e6 536277 1.39e6 610456 418694 748393 1.37e6  4819  1422 11227 139701 100927 82936 254696 81941 49938
## # ... with 25 more variables: CNS10 <dbl>, CNS11 <dbl>, CNS12 <dbl>, CNS13 <dbl>, CNS14 <dbl>, CNS15 <dbl>, CNS16 <dbl>,
## #   CNS17 <dbl>, CNS18 <dbl>, CNS19 <dbl>, CNS20 <dbl>, CR01 <dbl>, CR02 <dbl>, CR03 <dbl>, CR04 <dbl>, CR05 <dbl>, CR07 <dbl>,
## #   CT01 <dbl>, CT02 <dbl>, CD01 <dbl>, CD02 <dbl>, CD03 <dbl>, CD04 <dbl>, CS01 <dbl>, CS02 <dbl>
```

## Example - Part 3

Let's try to use LODES to get the job flows between CDPs in the Portland regions. 2017 is the latest year available -- it takes them a few years to put each release together. Unfortunately I noticed when putting this example together, `lehdr` which seems overall better documented and maintained, does not have a function to read the LODES crosswalk file. This is included in another LODES package and I actually wrote a version of this myself at one point. I filed a corresponding [issue on the `lehdr` GitHub](https://github.com/jamgreen/lehdr/issues/18) and will contribute if the author desires. The other package, [`lodes`](https://github.com/hrbrmstr/lodes), will be loaded to use the `read_xwalk()` function. 


```r
library(lodes)
```

```
## Error in library(lodes): there is no package called 'lodes'
```

```r
library(lehdr)
#Can only grab one state at a time right now
orwa_lodes =grab_lodes(state = c('or','wa'),year = 2017,lodes_type = 'od',
                            agg_geo = 'bg',segment = 'S000',state_part = c('aux')) %>%
  bind_rows(grab_lodes(state = c('or','wa'),year = 2017,lodes_type = 'od',
                            agg_geo = 'bg',segment = 'S000',state_part = c('main')))

orwa_xwalk = bind_rows(
  read_xwalk('or'),
  read_xwalk('wa')
)
```

```
## Error in read_xwalk("or"): could not find function "read_xwalk"
```

```r
sub_xwalk = orwa_xwalk %>% 
  filter(stplc %in% pdx_places$GEOID) %>%
  distinct(st,bgrp,stplc) %>%
  #Need to have all codes as character to join properly
  mutate_all(as.character)
```

```
## Error in filter(., stplc %in% pdx_places$GEOID): object 'orwa_xwalk' not found
```

```r
agg_plc_lodes = orwa_lodes %>%
  rename(total_jobs = `S000`) %>%
  group_by(h_bg,w_bg) %>%
  summarise(total_jobs = sum(total_jobs)) %>%
  left_join(sub_xwalk %>%
              rename(h_st = st,
                     h_bg = bgrp,
                     h_stplc=stplc)) %>%
  left_join(sub_xwalk %>%
              rename(w_st = st,
                     w_bg = bgrp,
                     w_stplc=stplc)) %>%
  group_by(h_st,h_stplc,w_st,w_stplc) %>%
  summarise(total_jobs = sum(total_jobs))
```

```
## Error in rename(., h_st = st, h_bg = bgrp, h_stplc = stplc): object 'sub_xwalk' not found
```

```r
#Going to use centroids to draw OD lines
pdx_plc_cents = pdx_places %>%
  st_centroid()

agg_plc_od_shp = agg_plc_lodes %>%
  ungroup() %>%
  filter(!is.na(h_stplc),!is.na(w_stplc),
         #Filtering out where home and work are same location (no line to draw...)
         h_stplc!=w_stplc) %>%
  mutate(od_line = pmap(.l = list(h_stplc,w_stplc),
                        .f = function(h_stplc,w_stplc){
    
    h_cent = pdx_plc_cents %>%
      filter(GEOID == h_stplc)
    
    w_cent = pdx_plc_cents %>%
      filter(GEOID == w_stplc)
    
    hw_line = bind_rows(
      h_cent %>% st_coordinates() %>% as_tibble(),
      w_cent %>% st_coordinates() %>% as_tibble()
    ) %>%
      #Have to convert to matrix to coerce into linestring
      as.matrix() %>%
      st_linestring()
    
    return(hw_line)
    
  })) %>%
  mutate(od_line = st_sfc(od_line,crs =2269)) %>%
  st_as_sf() %>%
  left_join(pdx_places %>%
              as_tibble() %>%
              select(GEOID,NAME) %>%
              rename(h_stplc = GEOID,
                     home_place = NAME)) %>%
  left_join(pdx_places %>%
              as_tibble() %>%
              select(GEOID,NAME) %>%
              rename(w_stplc = GEOID,
                     work_place = NAME))
```

```
## Error in ungroup(.): object 'agg_plc_lodes' not found
```

```r
#Setting a weight multiplier so job flow can be visualized proportionally on leaflet map
max_job_flow = max(agg_plc_od_shp$total_jobs)
```

```
## Error in eval(expr, envir, enclos): object 'agg_plc_od_shp' not found
```

```r
max_weight = 30
weight_mult = max_weight/max_job_flow
```

```
## Error in eval(expr, envir, enclos): object 'max_job_flow' not found
```

```r
leaflet() %>%
  addProviderTiles('CartoDB.Positron') %>%
  addPolylines(data = simp_pdx_ua %>% st_transform(4326),
               color='black',weight=2,group = 'Urban Area Boundary') %>%
  addPolygons(data = pdx_places %>% st_transform(4326),
              fillColor='green',fillOpacity = 0.5,color='white',
              weight=1,label=~NAMELSAD,
              highlightOptions = highlightOptions(weight=3,sendToBack = TRUE,
                                                  fillOpacity = 0.8),
              group='Place Polygons') %>%
  addPolylines(data=big_roads %>% st_transform(4326),
               color='blue',weight=~ifelse(MTFCC=='S1200',4,2),
               label=~FULLNAME,
               group='Roads') %>%
  addPolylines(data = agg_plc_od_shp %>% st_transform(4326),
               color = 'red',weight =~ total_jobs * weight_mult,
               label=~ paste0(home_place,' to ',work_place,': ',comma(total_jobs),' jobs'),
               opacity = 0.5,
               highlightOptions = highlightOptions(sendToBack = TRUE,opacity = 1),
               group='Job Flows') %>%
  addLayersControl(overlayGroups = c('Urban Area Boundary','Roads','Place Polygons','Job Flows'))
```

```
## Error in st_transform(., 4326): object 'agg_plc_od_shp' not found
```


# Reference Materials

## Run Through the Example Code Yourself
You can run through the example yourself based on the example code and data, which you can get by cloning (or just downloading as a ZIP) the [GitHub repository](https://github.com/PerkinsAndWill/nn_r_training) for this course and navigating to the `topics_setup/05_census` directory. There you will see `example_code.R`, and the raw Doodle results in the `data` folder. 

## Further Reading 

- *Analyzing the US Census with R*, written by Kyle Walker, is expected shortly per the [`tigris` GitHub page](https://github.com/walkerke/tigris). Until then, there are a lot of videos and blog posts on the web!

## Related DataCamp Courses

- [Analyzing U.S. Census Data with R (taught by Kyle Walker, creator of `tigris` and `tidycensus`! 1 course, 4 hours)](https://learn.datacamp.com/courses/analyzing-us-census-data-in-r)

*This content was presented to Nelson\\Nygaard Staff at a Lunch and Learn webinar on Friday, September 17th, 2020, and is [available as a recording here](https://web.microsoftstream.com/video/5b33f7da-577d-4788-b5b4-0340340c41f4) and embedded at the top of the page.*
